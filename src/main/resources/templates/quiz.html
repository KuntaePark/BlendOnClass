<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragment/default}">


    <title layout:title-pattern="$LAYOUT_TITLE - $CONTENT_TITLE">BlendOnClass</title>
    <!--    script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>   <-->
    <script src="https://cdn.tailwindcss.com"></script>

    <th:block layout:fragment="css"></th:block>


<div class="max-w-3xl mx-auto" layout:fragment="main">
    <div  class="container mx-auto px-4 py-6">
    <div class="flex gap-2 mb-4">
        <div th:each="i : ${#numbers.sequence(1, quizList.size())}"
             th:classappend="${i-1 == currentIndex} ? 'bg-gray-300' : 'bg-blue-300'"
             class="w-8 h-8 text-center leading-8 rounded-full text-white">
            <span th:text="${i}">1</span>
        </div>
    </div>

    <form id="quizForm" method="post" th:action="@{/quiz/grade}">
        <div>
            <div th:text="${quizList.get(currentIndex).contextJson}">ë¬¸ì œ ë‚´ìš©</div>
        </div>

        <div id="optionsBox">
            <!-- ê°ê´€ì‹/ì£¼ê´€ì‹ì— ë”°ë¼ ë™ì ìœ¼ë¡œ ë³€ê²½ë¨ -->
        </div>

        <input type="hidden" name="quizId" th:value="${quizList.get(currentIndex).quizId}" />
        <input type="hidden" name="lessonId" th:value="${lessonId}" />

        <button type="submit" class="mt-4 bg-blue-500 px-4 py-2 text-white rounded">ë‹¤ìŒ</button>
    </form>

    <div id="feedbackBox" class="mt-4 hidden">
        <p id="resultText" class="font-bold"></p>
        <p id="solutionText" class="text-sm text-gray-600 mt-2"></p>
    </div>
</div>

<script th:inline="javascript">
    // contextJson íŒŒì‹±
    const quiz = /*[[${quiz}]]*/ {};
    const gradeResult = /*[[${gradeResult}]]*/ null;

    const optionsBox = document.getElementById('optionsBox');
    const solutionBox = document.getElementById('solutionBox');
    const resultPopup = document.getElementById('resultPopup');

    const studentAnswerInput = document.getElementById('studentAnswer');
    const isChoice = quiz.quizType === 'CHOICE';

    // ğŸ‘‰ ì„ íƒì§€ í‘œì‹œ
    if (isChoice) {
        const context = JSON.parse(quiz.contextJson);
        optionsBox.innerHTML = ''; // ì´ˆê¸°í™”

        context.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.textContent = opt.optionNum + '. ' + opt.optionContext;
            btn.classList.add('option-btn', 'border', 'p-2', 'rounded', 'mb-2');
            btn.setAttribute('data-answer', opt.optionNum);

            btn.addEventListener('click', () => {
                // ì„ íƒëœ ê°’ hidden inputì— ì €ì¥
                studentAnswerInput.value = opt.optionNum;

                // ì‹œê°ì  íš¨ê³¼
                document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('bg-blue-100'));
                btn.classList.add('bg-blue-100');
            });

            optionsBox.appendChild(btn);
        });
    } else {
        // ì£¼ê´€ì‹ì´ë©´ input í•„ë“œ ë³´ì—¬ì£¼ê¸°
        optionsBox.innerHTML = `
            <input type="text" name="studentAnswer" id="studentAnswer" placeholder="ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" class="border p-2 w-full" />
        `;
    }

    // ğŸ‘‰ ì±„ì  ê²°ê³¼ í‘œì‹œ
    if (gradeResult) {
        const correct = gradeResult.correct;
        const correctAnswer = gradeResult.answer;
        const solution = gradeResult.solution;

        // ì •ë‹µ ì—¬ë¶€ íŒì—… í‘œì‹œ
        resultPopup.style.display = 'block';
        resultPopup.textContent = correct ? 'ì •ë‹µì…ë‹ˆë‹¤!' : 'ì˜¤ë‹µì…ë‹ˆë‹¤. ë‹¤ì‹œ ìƒê°í•´ë³´ì„¸ìš”!';

        // ì •ë‹µ í‘œì‹œ (ê°ê´€ì‹ì¼ ê²½ìš° ì •ë‹µ ë²ˆí˜¸ì— í‘œì‹œ)
        if (isChoice) {
            document.querySelectorAll('.option-btn').forEach(btn => {
                const answerNum = btn.getAttribute('data-answer');

                if (answerNum === correctAnswer) {
                    btn.classList.add(correct ? 'text-green-500' : 'text-red-500');
                    const label = correct ? '(ì •ë‹µ)' : '(ì •ë‹µ)';
                    btn.innerHTML += ` <span>${label}</span>`;
                }

                // ì‚¬ìš©ìê°€ ì„ íƒí•œ ë‹µ í‘œì‹œ
                if (answerNum === studentAnswerInput.value && !correct) {
                    btn.classList.add('text-red-400');
                    btn.innerHTML += ` <span>(ì˜¤ë‹µ)</span>`;
                }
            });
        }

        // í’€ì´ ë³´ê¸° ì˜ì—­
        solutionBox.textContent = solution;
        solutionBox.style.display = 'block';
    }
</script>
</div>

</html>